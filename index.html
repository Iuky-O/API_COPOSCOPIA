<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teste de Classificação — Upload de Imagem</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; background: #0f172a; color: #e2e8f0; }
    .container { max-width: 920px; margin: 40px auto; padding: 24px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p.muted { margin: 0 0 16px; color: #9ca3af; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 920px){ .row { grid-template-columns: 1fr 1fr; } }

    .endpoint { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    input[type="url"], input[type="text"] { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb; outline: none; }
    input[type="url"]:focus, input[type="text"]:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(59,130,246,.25); }

    .dropzone { position: relative; display: grid; place-items: center; text-align: center; border: 2px dashed #374151; border-radius: 16px; padding: 28px; background: #0b1220; cursor: pointer; transition: border-color .2s ease, background .2s ease; min-height: 240px; }
    .dropzone.dragover { border-color: #60a5fa; background: #0b1220; }
    .dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .thumb { margin-top: 12px; max-width: 100%; max-height: 260px; border-radius: 12px; border: 1px solid #1f2937; }

    .actions { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { appearance: none; border: none; border-radius: 999px; padding: 12px 18px; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; transition: filter .2s ease, transform .02s ease; }
    button.secondary { background: #374151; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    button:active { transform: translateY(1px); }

    .result { display: grid; gap: 8px; padding: 16px; border: 1px solid #1f2937; background: #0b1220; border-radius: 12px; }
    .result code { background: #0b1220; color: #93c5fd; padding: 2px 6px; border-radius: 6px; }

    .loader { width: 24px; height: 24px; border-radius: 50%; border: 3px solid #93c5fd; border-top-color: transparent; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error { color: #fca5a5; }
    .ok { color: #86efac; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Upload de Imagem • Classificador</h1>
      <p class="muted">Selecione uma imagem para enviar ao endpoint da API e ver a predição.</p>

      <div class="endpoint">
        <input id="endpoint" type="url" value="http://127.0.0.1:8000/api/predict" placeholder="URL do endpoint (ex.: http://127.0.0.1:8000/api/predict)" />
        <button id="ping" class="secondary" title="Testar conectividade">Ping</button>
      </div>

      <div class="row" style="margin-top:16px;">
        <div>
          <label class="dropzone" id="dropzone">
            <div>
              <strong>Arraste uma imagem aqui</strong>
              <div class="muted">ou clique para selecionar (JPG/PNG • até ~10 MB)</div>
              <img id="thumb" class="thumb" alt="Preview" style="display:none;" />
            </div>
            <input id="file" type="file" accept="image/*" />
          </label>
          <div class="actions" style="margin-top:12px;">
            <button id="predict" disabled>Enviar e Predizer</button>
            <button id="clear" class="secondary">Limpar</button>
            <span id="status"></span>
          </div>
        </div>

        <div>
          <div class="result" id="result">
            <div><strong>Status:</strong> <span id="statusText">Aguardando arquivo…</span></div>
            <div><strong>prediction_en:</strong> <code id="predEn">—</code></div>
            <div><strong>prediction_pt:</strong> <code id="predPt">—</code></div>
            <div style="display:none" id="rawBox"><strong>Resposta bruta:</strong> <code id="raw"></code></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const endpoint = $("endpoint");
    const fileInput = $("file");
    const dropzone = $("dropzone");
    const thumb = $("thumb");
    const predictBtn = $("predict");
    const clearBtn = $("clear");
    const statusEl = $("status");
    const statusText = $("statusText");
    const predEn = $("predEn");
    const predPt = $("predPt");
    const rawBox = $("rawBox");
    const raw = $("raw");

    function setLoading(isLoading) {
      predictBtn.disabled = isLoading || !fileInput.files?.[0];
      statusEl.innerHTML = isLoading ? '<span class="loader" aria-label="Carregando"></span> Processando…' : '';
    }

    function resetUI() {
      fileInput.value = "";
      thumb.style.display = "none";
      thumb.src = "";
      predictBtn.disabled = true;
      statusText.textContent = "Aguardando arquivo…";
      predEn.textContent = "—";
      predPt.textContent = "—";
      rawBox.style.display = "none";
      raw.textContent = "";
    }

    function isImage(file){ return file && file.type.startsWith('image/'); }

    dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e)=>{
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if(e.dataTransfer.files && e.dataTransfer.files[0]){
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', ()=>{
      if(fileInput.files && fileInput.files[0]){
        handleFile(fileInput.files[0]);
      }
    });

    function handleFile(file){
      if(!isImage(file)){
        alert('Por favor, selecione uma imagem válida.');
        return;
      }
      if(file.size > 10 * 1024 * 1024){ // 10MB
        alert('Arquivo muito grande (máximo 10 MB).');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        thumb.src = reader.result;
        thumb.style.display = 'block';
        statusText.textContent = `Pronto para enviar: ${file.name}`;
        predictBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    async function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = () => resolve((r.result||'').toString().split(',')[1] || '');
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    $("ping").addEventListener('click', async ()=>{
      try {
        const url = new URL(endpoint.value, window.location.origin).href;
        const res = await fetch(url.replace(/\/$/, '') + '/ping', { method: 'GET' });
        if(res.ok){
          statusText.textContent = 'Ping OK!';
        } else {
          statusText.textContent = `Ping falhou: HTTP ${res.status}`;
        }
      } catch(err){
        statusText.textContent = 'Não foi possível conectar (veja o console).';
        console.error(err);
      }
    });

    predictBtn.addEventListener('click', async ()=>{
      try{
        const file = fileInput.files?.[0];
        if(!file){ return; }
        setLoading(true);
        const b64 = await fileToBase64(file);

        const url = endpoint.value || '/api/predict';
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: b64 })
        });

        const data = await res.json().catch(() => ({ error: 'Resposta inválida da API' }));
        raw.textContent = JSON.stringify(data, null, 2);
        rawBox.style.display = 'block';

        if(!res.ok){
          statusText.innerHTML = `Erro: <span class="error">${data?.detail || data?.error || res.status}</span>`;
          predEn.textContent = '—';
          predPt.textContent = '—';
          return;
        }

        statusText.innerHTML = '<span class="ok">Predição concluída ✓</span>';
        predEn.textContent = data.prediction_en ?? '—';
        predPt.textContent = data.prediction_pt ?? '—';
      } catch(err){
        console.error(err);
        statusText.innerHTML = `Falha ao enviar: <span class="error">${err}</span>`;
      } finally {
        setLoading(false);
      }
    });

    clearBtn.addEventListener('click', resetUI);
  </script>
</body>
</html>
